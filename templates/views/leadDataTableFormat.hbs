<!DOCTYPE html>

<html lang="en" class="light-style layout-menu-fixed layout-compact" dir="ltr" data-theme="theme-default"
    data-assets-path="/assets/" data-template="vertical-menu-template-free">

<head>
    <meta charset="utf-8" />
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

    <title>Report</title>

    <meta name="description" content="" />

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/assets/img/favicon/favicon.ico" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap"
        rel="stylesheet" />

    <link rel="stylesheet" href="/assets/vendor/fonts/boxicons.css" />

    <!-- Core CSS -->
    <link rel="stylesheet" href="/assets/vendor/css/core.css" class="template-customizer-core-css" />
    <link rel="stylesheet" href="/assets/vendor/css/theme-default.css" class="template-customizer-theme-css" />
    <link rel="stylesheet" href="/assets/css/demo.css" />

    <!-- Vendors CSS -->
    <link rel="stylesheet" href="/assets/vendor/libs/perfect-scrollbar/perfect-scrollbar.css" />
    <link rel="stylesheet" href="/assets/vendor/libs/apex-charts/apex-charts.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css">

    <!-- Page CSS -->

    <!-- Helpers -->
    <script src="/assets/vendor/js/helpers.js"></script>
    <!--! Template customizer & Theme config files MUST be included after core stylesheets and helpers.js in the <head> section -->
    <!--? Config:  Mandatory theme config file contain global vars & default theme options, Set your preferred theme option in this file.  -->
    <script src="/assets/js/config.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.css" />
    <style>
        .secondy_container {
            background-color: #8080803d !important;
            backdrop-filter: blur(3px);
            box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
            color: #697a8d;
            padding: 20px;
            width: 100%;
            border-radius: 10px;
            margin-bottom: 10px;
        }
    </style>

    <style>
        #myTable_wrapper {
            color: white !important;
            font-weight: 200 !important;
        }

        /* Default styling for odd rows */
        table.dataTable tbody tr:nth-child(odd) {
            background-color: #f2f2f20f;
        }

        /* Default styling for even rows */
        table.dataTable tbody tr:nth-child(even) {
            background-color: #ffffff48;
        }

        /* Optionally, you can add hover effect */
        table.dataTable tbody tr:hover {
            background-color: #161515;
        }

        .dt-layout-row {
            background-color: #8080803d;
            padding: 10px;

        }

        .dt-layout-row:first-child {
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        .dt-layout-row:last-child {
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        }

        thead tr th {

            text-align: start !important;
        }

        tbody tr td {
            text-align: start !important;
            text-transform: capitalize !important;
            ;

        }
    </style>

</head>

<body>

    {{!-- Main Loader --}}
    <div class="loader-wrapper">
        <div class="main-loader">
            <div class="orbe" style="--index: 0"></div>
            <div class="orbe" style="--index: 1"></div>
            <div class="orbe" style="--index: 2"></div>
            <div class="orbe" style="--index: 3"></div>
            <div class="orbe" style="--index: 4"></div>
        </div>
    </div>
    <!-- Layout wrapper -->
    <div class="layout-wrapper layout-content-navbar">
        <div class="layout-container">
            <!-- Menu -->

            {{>Sidebar}}
            <!-- / Menu -->

            <!-- Layout container -->
            <div class="layout-page">
                <!-- Navbar -->

                {{>navBar}}
                <!-- / Navbar -->

                <!-- Content wrapper -->
                <div class="content-wrapper">
                    <!-- Content -->

                    <div class="container-xxl flex-grow-1 container-p-y">
                        <div class="secondy_container d-flex items-center justify-content-between">
                            <div class="form-group mt-2 " style="width: 30%;">
                                <h3>Custom Filter</h3>
                                <select class="form-select bg-transparent mr-5 outline-none" name="user_select"
                                    id="user_select" aria-label="Default select example"
                                    style="border: 1px solid rgb(153, 151, 151) !important;text-transform: capitalize;"
                                    fdprocessedid="30oqf">

                                    {{!-- dynamically append --}}


                                </select>
                            </div>


                            <div class="d-flex justify-content-between align-items-center" style="width: 50%;">
                                <div class="form-outline " style="width: 45%;">
                                    <label for="start_date">Start Date</label>
                                    <input type="date"
                                        class="form-control form-control-md rounded-0 cursor-pointer flatpickr-input active"
                                        id="start_date" name="start_date" placeholder="YYYY-MM-DD">
                                </div>
                                <div class="form-outline " style="width: 45%;">
                                    <label for="end_date">End Date</label>
                                    <input type="date"
                                        class="form-control form-control-md rounded-0 cursor-pointer flatpickr-input active"
                                        id="end_date" name="end_date" placeholder="YYYY-MM-DD">
                                </div>
                            </div>
                            <div>
                                <i class='bx bxs-download fs-3 cursor-pointer' style="color:green"
                                    title="download-report" id="downloadReport"></i>
                            </div>

                        </div>
                        <table id="myTable" class="display">
                            <thead>
                                <tr>
                                    <th>Company Name</th>
                                    <th>Stage</th>
                                    <th>Amount</th>
                                    <th>Contact No</th>
                                    <th>Source</th>
                                    <th>Responisble Person</th>
                                    <th>Created Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{!-- dynamic --}}
                            </tbody>
                        </table>

                    </div>

                    {{!-- <!-- Footer -->
                    {{>footer}}
                    <!-- / Footer --> --}}

                    <div class="content-backdrop fade"></div>
                </div>
                <!-- Content wrapper -->
            </div>
            <!-- / Layout page -->
        </div>

        <!-- Overlay -->
        <div class="layout-overlay layout-menu-toggle"></div>
    </div>


</body>

<!-- Main JS -->
<script src="/assets/js/main.js"></script>

<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

<script>
    const initialPipelineId = localStorage.getItem('pipeline_select_value');
    const email = localStorage.getItem('email');
    const usergroup = localStorage.getItem('user_group');
    let currentTableData = []; // Variable to store the current table data

    $(document).ready(function () {
        // Create a new DataTable instance
        const table = $('#myTable').DataTable();

        // Function to fetch and update table data
        function fetchAndUpdateTableData(pipeline_id, email, usergroup, user_id, start_date, end_date) {
            fetch(`/lead-table-data/${pipeline_id}`, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    usergroup: usergroup,
                    userId: user_id,
                    startDate: start_date,
                    endDate: end_date
                })
            }).then(res => res.json()).then(response => {

                if (response.success) {
                    // Clear existing table data
                    table.clear();
                    currentTableData = response.data; // Update the current table data

                    // Check if data array is empty
                    if (response.data.length === 0) {
                        // Display "No data available" message and redraw the table
                        table.draw();
                    } else {
                        // Append new data to the table
                        response.data.forEach(item => {
                            table.row.add([
                                item.companyName.replace('"', ""),
                                item.Stage,
                                item.Amount,
                                item.ContactNumber,
                                item.Source,
                                item.responsible_person,
                                item.createdAt.split('T')[0],
                            ]).draw();
                        });
                    }
                } else {
                    console.error('Failed to fetch data');
                }
            }).catch(error => {
                console.error('There has been a problem with your fetch operation:', error);
            });
        }

        // Function to download data as an Excel file
        function downloadExcel(data) {
            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Report");
            const wbout = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            const blob = new Blob([wbout], { type: 'application/octet-stream' });

            // Create a link element to trigger the download
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'leadreport.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Fetch initial table data
        fetchAndUpdateTableData(initialPipelineId, email, usergroup, null, null, null);

        // Appending options in the select dropdown
        fetch(`/get-pipeline-users/${initialPipelineId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {

                const user_select = document.querySelector('#user_select');
                user_select.innerHTML = '';
                // Create the first option to prompt the user to select a user
                if (usergroup === "admin") {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.innerText = 'Select user';
                    defaultOption.disabled = true;
                    defaultOption.selected = true;
                    user_select.append(defaultOption);
                }
                if (data.length > 0) {
                    data.forEach((item) => {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.innerText = item.username;
                        user_select.append(option);
                    });
                }
                // Add event listener to the select dropdown
                user_select.addEventListener('change', (e) => {
                    const selectedUserId = e.target.value;
                    const start_date = $('#start_date').val();
                    const end_date = $('#end_date').val();
                    fetchAndUpdateTableData(initialPipelineId, email, usergroup, selectedUserId, start_date, end_date);
                });
            })
            .catch(error => {
                console.error('There was a problem fetching pipeline users:', error);
            });

        // Event listeners for date input fields
        $('#start_date, #end_date').on('change', () => {
            const selectedUserId = $('#user_select').val();
            const start_date = $('#start_date').val();
            const end_date = $('#end_date').val();
            fetchAndUpdateTableData(initialPipelineId, email, usergroup, selectedUserId, start_date, end_date);
        });

        // Event listener for downloading the report
        $('#downloadReport').on('click', () => {
            if (currentTableData.length > 0) {
                downloadExcel(currentTableData);
            } else {
                alert('No data available to download');
            }
        });
    });
</script>



</html>